# Llama-2-7b å‰ªææŒ‡å— (ä½¿ç”¨Wanda)

## ğŸ“‹ æ¦‚è¿°

æœ¬æŒ‡å—è¯´æ˜å¦‚ä½•ä½¿ç”¨Wandaæ–¹æ³•å¯¹Llama-2-7bæ¨¡å‹è¿›è¡Œ50%ç¨€ç–åº¦çš„éç»“æ„åŒ–å‰ªæã€‚

## ğŸ”§ ä»£ç ä¿®æ”¹è¯´æ˜

ä¸ºäº†è§£å†³C4æ•°æ®é›†åŠ è½½é—®é¢˜å¹¶ä½¿ç”¨WikiText2æ•°æ®é›†,æˆ‘ä»¬å¯¹åŸå§‹ä»£ç è¿›è¡Œäº†ä»¥ä¸‹ä¿®æ”¹:

### 1. ä¿®æ”¹ `lib/data.py`
- **ä½ç½®**: ç¬¬43-44è¡Œ
- **åŸå› **: ä¿®å¤C4æ•°æ®é›†é…ç½®åç§°é”™è¯¯
- **ä¿®æ”¹**: å°† `'allenai--c4'` æ”¹ä¸º `'en'`
- **çŠ¶æ€**: âœ… å·²å®Œæˆ(å¤‡ç”¨æ–¹æ¡ˆ)

### 2. ä¿®æ”¹ `lib/prune.py`
- **ä½ç½®**: ç¬¬132è¡Œ (prune_wandaå‡½æ•°)
- **ä½ç½®**: ç¬¬218è¡Œ (prune_sparsegptå‡½æ•°)
- **ä½ç½®**: ç¬¬310è¡Œ (prune_ablateå‡½æ•°)
- **ä¿®æ”¹**: å°†æ ¡å‡†æ•°æ®é›†ä» `"c4"` æ”¹ä¸º `"wikitext2"`
- **åŸå› **: ä½¿ç”¨WikiText2ä½œä¸ºæ ¡å‡†æ•°æ®é›†
- **çŠ¶æ€**: âœ… å·²å®Œæˆ

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: ä½¿ç”¨æä¾›çš„è„šæœ¬(æ¨è)

```bash
cd wanda
chmod +x run_prune_llama2_7b.sh
./run_prune_llama2_7b.sh
```

### æ–¹æ³•2: æ‰‹åŠ¨è¿è¡Œå‘½ä»¤

```bash
cd wanda
python main.py \
    --model /mnt/sdb/llm_models/Llama-2-7b-hf \
    --prune_method wanda \
    --sparsity_ratio 0.5 \
    --sparsity_type unstructured \
    --save out/llama2_7b/unstructured/wanda/ \
    --save_model out/llama2_7b/unstructured/wanda/pruned_model \
    --nsamples 128 \
    --seed 0
```

## ğŸ“Š å‚æ•°è¯´æ˜

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `--model` | `/mnt/sdb/llm_models/Llama-2-7b-hf` | æ¨¡å‹è·¯å¾„ |
| `--prune_method` | `wanda` | å‰ªææ–¹æ³• |
| `--sparsity_ratio` | `0.5` | ç¨€ç–åº¦(50%) |
| `--sparsity_type` | `unstructured` | éç»“æ„åŒ–å‰ªæ |
| `--save` | `out/llama2_7b/...` | ç»“æœä¿å­˜è·¯å¾„ |
| `--save_model` | `out/llama2_7b/.../pruned_model` | å‰ªææ¨¡å‹ä¿å­˜è·¯å¾„ |
| `--nsamples` | `128` | æ ¡å‡†æ ·æœ¬æ•°é‡ |
| `--seed` | `0` | éšæœºç§å­ |

## ğŸ“ˆ é¢„æœŸè¾“å‡º

å‰ªæå®Œæˆå,ä½ å°†çœ‹åˆ°:

1. **ç¨€ç–åº¦æ£€æŸ¥**: ç¡®è®¤å®é™…ç¨€ç–åº¦çº¦ä¸º50%
2. **WikiTextå›°æƒ‘åº¦(PPL)**: è¯„ä¼°å‰ªæåæ¨¡å‹æ€§èƒ½
3. **æ—¥å¿—æ–‡ä»¶**: `out/llama2_7b/unstructured/wanda/log_wanda.txt`
4. **å‰ªææ¨¡å‹**: `out/llama2_7b/unstructured/wanda/pruned_model/`

### é¢„æœŸæ€§èƒ½å‚è€ƒ

æ ¹æ®Wandaè®ºæ–‡,Llama-2-7båœ¨50%éç»“æ„åŒ–ç¨€ç–åº¦ä¸‹çš„é¢„æœŸå›°æƒ‘åº¦:

- **Denseæ¨¡å‹**: ~5.12
- **Wandaå‰ªæ(50%)**: ~6.42

## ğŸ” æ•°æ®é›†è¯´æ˜

### æ ¡å‡†æ•°æ®é›†(Calibration Dataset)
- **å½“å‰ä½¿ç”¨**: WikiText2
- **ä½œç”¨**: ç”¨äºè®¡ç®—æ¿€æ´»å€¼,æŒ‡å¯¼å‰ªæè¿‡ç¨‹
- **æ ·æœ¬æ•°**: 128ä¸ªåºåˆ—

### è¯„ä¼°æ•°æ®é›†(Evaluation Dataset)
- **ä½¿ç”¨**: WikiText2
- **ä½œç”¨**: è¯„ä¼°å‰ªæåæ¨¡å‹çš„å›°æƒ‘åº¦(PPL)
- **è‡ªåŠ¨æ‰§è¡Œ**: æ— éœ€é¢å¤–é…ç½®

## ğŸ› ï¸ æ•…éšœæ’é™¤

### é—®é¢˜1: C4æ•°æ®é›†åŠ è½½å¤±è´¥
**é”™è¯¯**: `ValueError: BuilderConfig 'allenai--c4' not found`

**è§£å†³æ–¹æ¡ˆ**: 
- å·²ä¿®æ”¹ä¸ºä½¿ç”¨WikiText2æ•°æ®é›†
- æˆ–è€…ä¿®æ”¹ `lib/data.py` ç¬¬43-44è¡Œ,å°† `'allenai--c4'` æ”¹ä¸º `'en'`

### é—®é¢˜2: å†…å­˜ä¸è¶³
**è§£å†³æ–¹æ¡ˆ**:
- å‡å°‘ `--nsamples` å‚æ•°(é»˜è®¤128)
- ä½¿ç”¨æ›´å°çš„æ¨¡å‹æˆ–æ›´å°‘çš„GPU

### é—®é¢˜3: CUDAè®¾å¤‡é€‰æ‹©
**è§£å†³æ–¹æ¡ˆ**:
```bash
export CUDA_VISIBLE_DEVICES=0  # ä½¿ç”¨GPU 0
# æˆ–
export CUDA_VISIBLE_DEVICES=1  # ä½¿ç”¨GPU 1
```

## ğŸ“ å…¶ä»–å‰ªæé€‰é¡¹

### ç»“æ„åŒ–å‰ªæ (2:4)
```bash
python main.py \
    --model /mnt/sdb/llm_models/Llama-2-7b-hf \
    --prune_method wanda \
    --sparsity_ratio 0.5 \
    --sparsity_type 2:4 \
    --save out/llama2_7b/2-4/wanda/
```

### ç»“æ„åŒ–å‰ªæ (4:8)
```bash
python main.py \
    --model /mnt/sdb/llm_models/Llama-2-7b-hf \
    --prune_method wanda \
    --sparsity_ratio 0.5 \
    --sparsity_type 4:8 \
    --save out/llama2_7b/4-8/wanda/
```

## ğŸ”„ æ¢å¤åˆ°C4æ•°æ®é›†

å¦‚æœä½ æƒ³ä½¿ç”¨C4æ•°æ®é›†è€Œä¸æ˜¯WikiText2:

1. ä¿®æ”¹ `lib/prune.py` ä¸­çš„ä¸‰å¤„:
   - ç¬¬132è¡Œ: æ”¹å› `"c4"`
   - ç¬¬218è¡Œ: æ”¹å› `"c4"`
   - ç¬¬310è¡Œ: æ”¹å› `"c4"`

2. ç¡®ä¿ `lib/data.py` ç¬¬43-44è¡Œä½¿ç”¨ `'en'` é…ç½®

## ğŸ“š å‚è€ƒèµ„æ–™

- **Wandaè®ºæ–‡**: [A Simple and Effective Pruning Approach for Large Language Models](https://arxiv.org/abs/2306.11695)
- **åŸå§‹ä»“åº“**: [locuslab/wanda](https://github.com/locuslab/wanda)
- **æ¨¡å‹**: Llama-2-7b-hf

## âœ… æ£€æŸ¥æ¸…å•

- [x] ä¿®æ”¹æ•°æ®é›†åŠ è½½ä»£ç 
- [x] åˆ›å»ºæ‰§è¡Œè„šæœ¬
- [x] éªŒè¯æ¨¡å‹è·¯å¾„
- [ ] è¿è¡Œå‰ªæ
- [ ] æ£€æŸ¥è¾“å‡ºç»“æœ
- [ ] éªŒè¯å‰ªææ¨¡å‹æ€§èƒ½

## ğŸ’¡ æç¤º

1. **é¦–æ¬¡è¿è¡Œ**: WikiText2æ•°æ®é›†ä¼šè‡ªåŠ¨ä¸‹è½½,å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ
2. **æ¨¡å‹åŠ è½½**: Llama-2-7båŠ è½½éœ€è¦çº¦13GBæ˜¾å­˜
3. **å‰ªææ—¶é—´**: æ•´ä¸ªå‰ªæè¿‡ç¨‹å¯èƒ½éœ€è¦30-60åˆ†é’Ÿ
4. **ä¿å­˜æ¨¡å‹**: å‰ªæåçš„æ¨¡å‹å¤§å°çº¦ä¸ºåŸæ¨¡å‹çš„50%(å› ä¸ºæƒé‡è¢«ç½®é›¶)

## ğŸ“§ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜,è¯·å‚è€ƒåŸå§‹Wandaä»“åº“çš„Issuesæˆ–è”ç³»ä½œè€…ã€‚

